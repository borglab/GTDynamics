# This workflow builds the Python wheels using cibuildwheel.
# It can be triggered on push or manually via Github Actions.

name: Build Python Wheels

on:
  push:
    branches:
      - main
      - master
      - develop
      - feature/python-wheels-ci # For testing purposes
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

# Default minimal permissions for all jobs
permissions:
  contents: read

jobs:
  build_wheels:
    name: Build Wheels - ${{ matrix.os }} - Python ${{ matrix.python_version }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            python_version: "3.10"
            cibw_python_version: 310
            platform_id: manylinux_x86_64
            manylinux_image: manylinux2014
          - os: ubuntu-latest
            python_version: "3.11"
            cibw_python_version: 311
            platform_id: manylinux_x86_64
            manylinux_image: manylinux2014
          - os: ubuntu-latest
            python_version: "3.12"
            cibw_python_version: 312
            platform_id: manylinux_x86_64
            manylinux_image: manylinux2014
          - os: ubuntu-latest
            python_version: "3.13"
            cibw_python_version: 313
            platform_id: manylinux_x86_64
            manylinux_image: manylinux2014

          # Linux aarch64
          - os: ubuntu-24.04-arm
            python_version: "3.10"
            cibw_python_version: 310
            platform_id: manylinux_aarch64
            manylinux_image: manylinux2014
          - os: ubuntu-24.04-arm
            python_version: "3.11"
            cibw_python_version: 311
            platform_id: manylinux_aarch64
            manylinux_image: manylinux2014
          - os: ubuntu-24.04-arm
            python_version: "3.12"
            cibw_python_version: 312
            platform_id: manylinux_aarch64
            manylinux_image: manylinux2014
          - os: ubuntu-24.04-arm
            python_version: "3.13"
            cibw_python_version: 313
            platform_id: manylinux_aarch64
            manylinux_image: manylinux2014

          # MacOS x86_64
          - os: macos-15-intel
            python_version: "3.10"
            cibw_python_version: 310
            platform_id: macosx_x86_64
          - os: macos-15-intel
            python_version: "3.11"
            cibw_python_version: 311
            platform_id: macosx_x86_64
          - os: macos-15-intel
            python_version: "3.12"
            cibw_python_version: 312
            platform_id: macosx_x86_64
          - os: macos-15-intel
            python_version: "3.13"
            cibw_python_version: 313
            platform_id: macosx_x86_64

          # MacOS arm64
          - os: macos-latest
            python_version: "3.10"
            cibw_python_version: 310
            platform_id: macosx_arm64
          - os: macos-latest
            python_version: "3.11"
            cibw_python_version: 311
            platform_id: macosx_arm64
          - os: macos-latest
            python_version: "3.12"
            cibw_python_version: 312
            platform_id: macosx_arm64
          - os: macos-latest
            python_version: "3.13"
            cibw_python_version: 313
            platform_id: macosx_arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python_version }}

      - name: Install cibuildwheel
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r python/dev_requirements.txt

      - name: Install host system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Install host system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja boost
          brew tap osrf/simulation
          brew install sdformat15

      - name: Build wheels with cibuildwheel
        env:
          # Generate the platform identifier. See https://cibuildwheel.pypa.io/en/stable/options/#build-skip.
          CIBW_BUILD: cp${{ matrix.cibw_python_version }}-${{ matrix.platform_id }}
          CIBW_MANYLINUX_X86_64_IMAGE: ${{ matrix.manylinux_image }}
          CIBW_MANYLINUX_AARCH64_IMAGE: ${{ matrix.manylinux_image }}
          CIBW_ARCHS: all
          
          # Set the minimum required macOS version for the wheels.
          MACOSX_DEPLOYMENT_TARGET: "10.15"

          # Set DYLD_LIBRARY_PATH to REPAIR_LIBRARY_PATH for macOS wheel repair
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: "DYLD_LIBRARY_PATH=$REPAIR_LIBRARY_PATH delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}"

          # Use build frontend (recommended by PyPA)
          # See https://cibuildwheel.pypa.io/en/stable/options/#build-frontend.
          CIBW_BUILD_FRONTEND: "build"
          
          # Install dependencies before building wheel
          CIBW_BEFORE_ALL: "bash {project}/.github/scripts/cibw_before_all.sh ${{ matrix.python_version }} {project}"
          
          # Build from the build/python directory where setup.py is located
          CIBW_PROJECT_REQUIRES_PYTHON: ">=3.10"
          
          CIBW_BUILD_VERBOSITY: 1
        run: |
          python3 -m cibuildwheel --output-dir wheelhouse

      - name: Store artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-cp${{ matrix.cibw_python_version }}-${{ matrix.platform_id }}
          path: wheelhouse/*.whl

  upload_all:
    name: Upload All Wheels
    needs: build_wheels
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: cibw-wheels-*
          merge-multiple: true

      - name: List wheels
        run: ls -la dist/

      - name: Upload combined wheels
        uses: actions/upload-artifact@v4
        with:
          name: all-wheels
          path: dist/*.whl
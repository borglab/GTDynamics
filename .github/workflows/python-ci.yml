# GitHub Actions workflow for Continuous Integration of GTDynamics Python bindings
# This workflow tests the Python bindings across multiple platforms and build configurations
name: Python CI

# Trigger this workflow on pull requests to ensure changes don't break Python functionality
on: [pull_request]

jobs:
  build:
    # Job name includes OS, build type, and Python version for clear identification
    name: ${{ matrix.name }} ${{ matrix.build_type }} Python ${{ matrix.python_version }}
    runs-on: ${{ matrix.os }}

    # Environment variables used throughout the build process
    env:
      CTEST_OUTPUT_ON_FAILURE: ON  # Show full test output on failure for debugging
      CTEST_PARALLEL_LEVEL: 2      # Run tests in parallel to speed up CI
      CMAKE_BUILD_TYPE: ${{ matrix.build_type }}
      PYTHON_VERSION: ${{ matrix.python_version }} 
      GTSAM_INSTALL_DIR_MACOS: ${{ github.workspace }}/gtsam_install_prefix  # Custom GTSAM install location on macOS 

    # Test matrix strategy: run jobs across different OS, compilers, build types, and Python versions
    strategy:
      fail-fast: false  # Continue running other matrix jobs even if one fails
      matrix:
        # Test on Ubuntu with GCC and Clang, and macOS with Xcode
        name: [ubuntu-22.04-gcc-9, ubuntu-22.04-clang-12, macOS-14-xcode-15.4]
        build_type: [Debug, Release]  # Test both debug and optimized builds
        python_version: [3]           # Python 3.x (specific minor version determined by runner)
        include:
          # Ubuntu 22.04 with GCC 9
          - name: ubuntu-22.04-gcc-9
            os: ubuntu-22.04
            compiler: gcc
            version: "9"
          # Ubuntu 22.04 with Clang 12  
          - name: ubuntu-22.04-clang-12
            os: ubuntu-22.04
            compiler: clang
            version: "12"
          # macOS 14 with Xcode 15.4
          - name: macOS-14-xcode-15.4
            os: macOS-14
            compiler: xcode
            version: "15.4"

    steps:
      # Step 1: Checkout the GTDynamics repository
      - name: Checkout GTDynamics (Your Project)
        uses: actions/checkout@v4

      # Step 2: Install system-level dependencies on Linux
      - name: Install System Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          # Update package lists
          sudo apt-get -y update
          # Install appropriate compiler based on matrix configuration
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            sudo apt-get install -y g++-${{ matrix.version }} g++-${{ matrix.version }}-multilib
            echo "CC=gcc-${{ matrix.version }}" >> $GITHUB_ENV
            echo "CXX=g++-${{ matrix.version }}" >> $GITHUB_ENV
          else
            sudo apt-get install -y clang-${{ matrix.version }} g++-multilib
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi
          # Add OSRF (Open Source Robotics Foundation) repository for Gazebo/SDF packages
          sudo sh -c 'echo "deb http://packages.osrfoundation.org/gazebo/ubuntu-stable `lsb_release -cs` main" > /etc/apt/sources.list.d/gazebo-stable.list'
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys D2486D2DD83DB69272AFE98867170598AF249743
          sudo apt-get -y update
          # Install required libraries: TBB (threading), Boost (utilities), and SDF (robot description format)
          sudo apt-get -y install libtbb-dev libboost-all-dev libsdformat12-dev

      # Step 3: Install system-level dependencies on macOS
      - name: Install System Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          # Install appropriate compiler based on matrix configuration
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            brew install gcc@${{ matrix.version }}
            echo "CC=gcc-${{ matrix.version }}" >> $GITHUB_ENV
            echo "CXX=g++-${{ matrix.version }}" >> $GITHUB_ENV
          else
            # Switch to the specified Xcode version
            sudo xcode-select -switch /Applications/Xcode_${{ matrix.version }}.app
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi
          # Install Boost libraries via Homebrew
          brew install boost
          # Add OSRF tap for robotics packages and install SDF
          brew tap osrf/simulation
          brew install sdformat12

      # Step 4: Install Python dependencies on Linux (system-wide installation)
      - name: Python Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          # Install required Python packages for building and testing
          # setuptools<70: version constraint for compatibility
          # pybind11-stubgen: generates Python stub files for C++ bindings
          pip3 install -U "setuptools<70" wheel numpy pyparsing pyyaml "pybind11-stubgen>=2.5.1"
        
      # Step 5: Setup Python virtual environment and dependencies on macOS
      - name: Python Dependencies and venv Setup (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -e  # Exit on any error
          # Create a Python virtual environment to isolate dependencies
          python${{ env.PYTHON_VERSION }} -m venv venv
          source venv/bin/activate
          # Store the virtual environment Python executable path for later use
          echo "VENV_PYTHON_EXECUTABLE=${{ github.workspace }}/venv/bin/python" >> $GITHUB_ENV
          echo "${{ github.workspace }}/venv/bin" >> $GITHUB_PATH
          # Upgrade pip and install required packages in the virtual environment
          python -m pip install --upgrade pip
          python -m pip install --break-system-packages -U "setuptools<70" wheel numpy pyparsing pyyaml "pybind11-stubgen>=2.5.1"

      # Step 6: Build and install GTSAM (Georgia Tech Smoothing and Mapping library) on Linux
      - name: GTSAM (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e
          # Clone GTSAM from the official repository
          git clone https://github.com/borglab/gtsam.git /tmp/gtsam_source_linux 
          cd /tmp/gtsam_source_linux
          mkdir build && cd $_
          # Configure GTSAM with Python bindings enabled, examples disabled for faster build
          cmake -D GTSAM_BUILD_EXAMPLES_ALWAYS=OFF -DGTSAM_BUILD_PYTHON=ON ..
          # Build and install GTSAM system-wide
          sudo make -j$(nproc) install 
          # Install GTSAM Python bindings
          make python-install 
          # Update library cache so system can find GTSAM libraries
          sudo ldconfig
          cd ${{ github.workspace }} 
          # Clean up temporary build directory
          sudo rm -rf /tmp/gtsam_source_linux

      # Step 7: Build and install GTSAM on macOS with custom install location
      - name: GTSAM (macOS)
        if: runner.os == 'macOS'
        shell: bash 
        run: |
          set -e 
          # Clone GTSAM from the official repository
          git clone https://github.com/borglab/gtsam.git /tmp/gtsam_source_macos
          cd /tmp/gtsam_source_macos
          mkdir build && cd $_
          # Configure GTSAM for macOS with specific options:
          # - Disable TBB (Threading Building Blocks) to avoid conflicts
          # - Use the virtual environment Python executable
          # - Install to custom prefix to avoid system-wide installation
          cmake -D GTSAM_BUILD_EXAMPLES_ALWAYS=OFF \
                -D GTSAM_BUILD_PYTHON=ON \
                -D GTSAM_WITH_TBB=OFF \
                -D PYTHON_EXECUTABLE=${{ env.VENV_PYTHON_EXECUTABLE }} \
                -D CMAKE_INSTALL_PREFIX=${{ env.GTSAM_INSTALL_DIR_MACOS }} \
                ..
          # Build and install GTSAM using all available CPU cores
          make -j$(sysctl -n hw.physicalcpu) install 
          make -j$(sysctl -n hw.physicalcpu) python-install 
          cd ${{ github.workspace }} 
          # Clean up temporary build directory
          rm -rf /tmp/gtsam_source_macos 

      # Step 8: Create build directory for GTDynamics
      - name: Build Directory for GTDynamics
        run: mkdir build 

      # Step 9: Configure GTDynamics build on Linux
      - name: Configure GTDynamics (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e
          # Enable Python bindings for GTDynamics
          # GTSAM should be found automatically since it was installed system-wide
          cmake -DGTDYNAMICS_BUILD_PYTHON=ON ..
        working-directory: ./build

      # Step 10: Configure GTDynamics build on macOS with custom paths
      - name: Configure GTDynamics (macOS)
        if: runner.os == 'macOS'
        shell: bash 
        run: |
          set -e
          # Set path to GTSAM CMake configuration files
          GTSAM_CONFIG_DIR_PATH="${{ env.GTSAM_INSTALL_DIR_MACOS }}/lib/cmake/GTSAM"
          # Configure GTDynamics with:
          # - Python bindings enabled
          # - Virtual environment Python executable
          # - Custom GTSAM installation location
          # - Homebrew prefix in CMAKE_PREFIX_PATH for finding dependencies
          cmake -DGTDYNAMICS_BUILD_PYTHON=ON \
                -DPYTHON_EXECUTABLE=${{ env.VENV_PYTHON_EXECUTABLE }} \
                -DGTSAM_DIR="${GTSAM_CONFIG_DIR_PATH}" \
                -DCMAKE_PREFIX_PATH="${{ env.GTSAM_INSTALL_DIR_MACOS }};$(brew --prefix)" \
                ..
        working-directory: ./build

      # Step 11: Build GTDynamics using all available CPU cores
      - name: Build GTDynamics
        run: make -j$(if [[ "$(uname)" == "Darwin" ]]; then sysctl -n hw.physicalcpu; else nproc; fi)
        working-directory: ./build

      # Step 12: Install GTDynamics Python bindings
      - name: Install GTDynamics Python Wrappers
        shell: bash 
        run: |
          set -e
          # Use appropriate privileges based on OS:
          # - macOS: no sudo needed since using custom install prefix and virtual environment
          # - Linux: sudo needed for system-wide installation
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            make -j$(sysctl -n hw.physicalcpu) python-install 
          else
            sudo make -j$(nproc) python-install
          fi
        working-directory: ./build

      # Step 13: Run Python tests on macOS with proper environment setup
      - name: Test GTDynamics Python
        # For macOS, set DYLD_LIBRARY_PATH so the dynamic linker can find the installed GTSAM libraries.
        # Also, ensure the venv is active for the context of running the tests.
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -e
          # Activate the virtual environment to ensure correct Python and packages are used
          source ${{ github.workspace }}/venv/bin/activate # Ensure venv Python and its site-packages are primary
          # Set library path so macOS can find GTSAM dynamic libraries
          export DYLD_LIBRARY_PATH="${{ env.GTSAM_INSTALL_DIR_MACOS }}/lib${DYLD_LIBRARY_PATH:+:$DYLD_LIBRARY_PATH}"
          echo "DYLD_LIBRARY_PATH is set to: $DYLD_LIBRARY_PATH"
          # Run Python tests using all available CPU cores
          make -j$(sysctl -n hw.physicalcpu) python-test
        working-directory: ./build
        
      # Step 14: Run Python tests on Linux
      - name: Test GTDynamics Python (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e
          # On Linux, sudo ldconfig during GTSAM install should handle library paths for system-wide installs.
          # If GTSAM was installed to a custom prefix not in ldconfig paths, LD_LIBRARY_PATH would be needed.
          make -j$(nproc) python-test
        working-directory: ./build
